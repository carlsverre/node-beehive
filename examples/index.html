<html>
  <head>
    <title>Node-Beehive Example Worker</title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js" type="text/javascript"></script>
    <script src="js/beehive-client.js" type="text/javascript"></script>
    <script type="text/javascript">
      $(document).ready(function() {
        var hive = new BeehiveClient({
          debug: function(s) {
            $('#log').append("<br>"+s);
          },
          debugLevel: 5
        });

        hive.jobLoop();

        $("#pause").click(hive.pause);
        $("#resume").click(hive.resume);
        $("#clear").click(function() {
          $('#log').html('');
        });

        var imageRefreshTime = 500;
        var image = document.getElementById('image');
        var ctx = image.getContext('2d');
        var last = 0;

        function imageError() {
          $('#log').append("<br>Error getting image-data!");
          setTimeout(loopUpdateImage, imageRefreshTime);
        }

        function loopUpdateImage() {
          if(hive.paused()) setTimeout(loopUpdateImage, imageRefreshTime);
          else updateImage();
        }

        function getImage() {
          $.ajax({
            url: '/pixels/',
            dataType: 'json',
            success: function(data) {
              if(!data) return imageError();
              var canvasData = ctx.getImageData(0,0,image.width,image.height);
              canvasData.data = data;
              ctx.putImageData(canvasData,0,0);
              setTimeout(loopUpdateImage, imageRefreshTime);
            }
          });
        }

        function updateImage() {
          $.ajax({
            url: '/pixels/'+last,
            dataType: 'json',
            success: function(data) {
              if(!data || data==[]) return imageError();
              var canvasData = ctx.getImageData(0,0,image.width,image.height);
              $.each(data.reverse(), function(i, item) {
                var p = item.value;
                var idx = (p.y+p.x*image.height) * 4;
                canvasData.data[idx]    = p.color[0];
                canvasData.data[idx+1]  = p.color[1];
                canvasData.data[idx+2]  = p.color[2];
                canvasData.data[idx+3]  = p.color[3];

                if(i == (data.length-1)) {
                  last = item.offset;
                  ctx.putImageData(canvasData, 0, 0);
                  setTimeout(loopUpdateImage, imageRefreshTime);
                }
              });
            }
          });
        }

        getImage();
      });
    </script>
  </head>
  <body>
    <canvas id="image" width="50" height="50">You need Canvas to see the result</canvas>
    <br />
    <input name="pause" type="button" id="pause" value="pause" class="button" />
    <input name="resume" type="button" id="resume" value="Resume" class="button" />
    <input name="clear" type="button" id="clear" value="clear" class="button" />
    <div id="log" style="border: 1px #000 solid; width: 500px; height 500px;"></div>
  </body>
</html>
